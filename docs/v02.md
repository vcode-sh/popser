# Popser v0.2.0 — Implementation Plan

> Based on a full audit of popser v0.1.6, Base UI Toast v1.2.0, and Sonner v2.0.7.

---

## Current State (v0.1.6)

- 279 tests, 98.29% coverage
- 32+ Sonner GitHub issues addressed by architecture
- Full imperative API: `toast()`, typed variants, `.promise()`, `.close()`, `.update()`, `.dismiss()`, `.getToasts()`
- Complete component system: Toaster, icons, 3-mode close button, action buttons, 11 classNames slots
- CSS: OKLCH tokens, light/dark, rich colors, mobile responsive, collapsed stacking
- Base UI `@base-ui/react` ^1.2.0 peer dep

---

## Audit Findings

### Bugs (must fix)

| ID | Issue | File | Severity |
|----|-------|------|----------|
| B1 | Promise toast uses invalid `"default"` type + `timeout: 1` when success/error callback returns `undefined` | `toast.ts:103-114` | High |
| B2 | Error boundary returns `null` silently — no logging, no fallback | `toaster.tsx:38-41` | Medium |
| B3 | `onRemove` callback passed through to Base UI but undocumented — users don't know when it fires vs `onClose` | `types.ts`, docs | Medium |
| B4 | `data` field collision — user's `data` prop can be overwritten by popser-internal fields (icon, action, cancel, className, style, dismissible) | `toast-mapper.ts` | Medium |
| B5 | `untrackToast()` is O(n) — iterates `activeToastTitles` map to find entry by ID | `toast-tracker.ts` | Low |

### Type Safety Gaps

| ID | Issue | File |
|----|-------|------|
| T1 | Manager not parameterized — `Toast.createToastManager()` defaults to `any` instead of `PopserToastData` | `manager.ts` |
| T2 | Unsafe cast `toastData.data as PopserToastData` without runtime validation | `toast-root.tsx:34` |
| T3 | `type as keyof PopserIcons` cast in icon resolution — safe due to optional chaining but fragile | `toast-icon.tsx:103` |

### Sonner API Gaps (by impact)

| Priority | Feature | Sonner | Popser v0.1.6 |
|----------|---------|--------|----------------|
| **P0** | `toast.custom(jsx)` | `toast.custom((id) => <JSX />)` | Missing |
| **P0** | Enhanced `toast.promise()` | Lazy `() => Promise`, per-state options (icon, action, duration), `finally`, `.unwrap()` | Basic: string/ReactNode/fn only |
| **P1** | Per-toast `classNames` | Full `ToastClassnames` per toast | Toaster-level only |
| **P1** | Per-toast `unstyled` | `toast("msg", { unstyled: true })` | Toaster-level only |
| **P1** | `pauseOnHover` control | Always on (no control) | Always on (Base UI built-in, no control) |
| **P1** | Action/Cancel as ReactNode | `action: <Button>Undo</Button>` | Only `{ label, onClick }` object |
| **P2** | Per-toast `position` override | `toast("msg", { position: "top-center" })` | Toaster-level only |
| **P2** | Per-toast `richColors` | Per toast | Toaster-level only |
| **P2** | `toast.message()` | Explicit normal-type toast | Missing (trivial) |
| **P2** | Callback receives toast object | `onDismiss(toast: ToastT)` | Callbacks receive no arguments |
| **P3** | Multiple Toasters | `<Toaster id="x" />` + `toast("msg", { toasterId: "x" })` | Single manager |
| **P3** | `toast.getHistory()` | All past toasts | Not planned |
| **P3** | `invert` prop | Per-toast and global | Not planned (use `theme`) |
| **P3** | `dir` (RTL) | `dir="rtl"` on Toaster | Base UI handles |
| **P3** | `duration: Infinity` | Persistent toast | Use `timeout: 0` |
| **P3** | `hotkey` customization | `hotkey={["altKey", "KeyT"]}` | F6 (Base UI standard) |
| **P3** | Per-toast type-specific classNames | `classNames.success`, `.error`, etc. | Use `data-type` CSS selectors |

### Base UI Features Not Exposed

| Feature | Base UI API | Status |
|---------|-------------|--------|
| Generic manager | `createToastManager<Data>()` | Trivial — 1 line change |
| `Toast.Positioner` | Anchor to DOM element | Available since v1.0.0 |
| `Toast.Arrow` | Arrow pointing at anchor | Available since v1.0.0 |
| `render` prop on `Toast.Root` | Full custom rendering | Available |
| `data-limited` styling | Distinct exit for limit-exceeded | CSS available, not styled |
| `data-swipe-direction` exit | Direction-specific exit animation | CSS available, not styled |

---

## v0.2.0 Scope

### Principles

1. **No breaking changes.** All v0.1 code continues to work.
2. **Sonner parity where sensible.** Match the API surface developers expect.
3. **Leverage Base UI.** Don't reimplement what the primitives provide.
4. **Test everything.** Maintain 90%+ coverage thresholds.

---

## Phase 1 — Bug Fixes & Type Safety

_No new features. Ship as v0.1.7 patch if needed._

### 1.1 Fix promise undefined return (B1)

**Problem:** When `success(result)` or `error(err)` returns `undefined`, we create a toast with `type: "default"` (invalid) and `timeout: 1` (fragile). The intent is "don't show a toast", but we create a ghost toast instead.

**Fix:** Use Base UI's native behavior. When the callback returns `undefined`, update the toast to a closing state:

```typescript
// toast.ts — successHandler
const successHandler = typeof success === "function"
  ? (result: T) => {
      const title = success(result);
      if (title === undefined) {
        // Close the loading toast instead of showing a ghost
        return { title: "", type: "success" as const, timeout: 1 };
      }
      return { title, type: "success" as const };
    }
  : { title: success, type: "success" as const };
```

**Better approach:** Since Base UI blocks updates to ending toasts (PR #4040), we can't close from within the handler. Instead, return a minimal success toast that auto-dismisses. But change `type` from `"default"` to `"success"` (valid PopserType) and use `timeout: 0` (Base UI interprets as "never auto-dismiss" — actually we want instant dismiss).

**Best approach:** After the promise handler fires, check if the result was `undefined` and immediately call `manager.close(id)`:

```typescript
// toast.ts — wrap the promise
const wrappedPromise = promise.then((result) => {
  if (typeof success === "function") {
    const title = success(result);
    if (title === undefined) {
      // Schedule close after Base UI processes the update
      queueMicrotask(() => getManager().close(toastId));
    }
  }
  return result;
});
```

**Files:** `toast.ts`
**Tests:** Update promise tests to verify ghost toast is closed, not created.

### 1.2 Fix error boundary (B2)

**Problem:** Error boundary returns `null` — toast vanishes silently.

**Fix:** Add `console.error` in `componentDidCatch` and render a minimal fallback:

```typescript
componentDidCatch(error: Error, info: React.ErrorInfo) {
  console.error("[popser] Toast rendering failed:", error, info);
}

render() {
  if (this.state.hasError) {
    return null; // Still null — can't render a toast if rendering failed
  }
  return this.props.children;
}
```

Keep returning `null` (rendering a broken toast is worse), but log the error so developers can debug.

**Files:** `toaster.tsx`
**Tests:** Add error boundary test — verify console.error fires when toast rendering throws.

### 1.3 Document onRemove (B3)

**Problem:** `onRemove` is accepted in options but its semantics are unclear.

**Fix:**
- Add JSDoc to `PopserOptions.onRemove`: "Called after the toast's exit animation completes and it is removed from the DOM. Fires after `onClose`/`onAutoClose`/`onDismiss`."
- Update docs with callback firing order: `onDismiss`/`onAutoClose` → `onClose` → (exit animation) → `onRemove`

**Files:** `types.ts`, `docs/popser-sonner.md`

### 1.4 Fix data field collision (B4)

**Problem:** User's `data: { icon: "custom" }` is overwritten by popser's internal `icon` field.

**Fix:** Namespace internal fields under `__popser` key:

```typescript
// toast-mapper.ts — toManagerOptions
data: {
  ...data,
  __popser: { icon, action, cancel, className, style, dismissible },
}

// toast-root.tsx — reading data
const popserData = (toastData.data?.__popser ?? {}) as PopserInternalData;
const userData = toastData.data;
```

**Breaking internally** but not a public API change. Type changes are internal.

**Files:** `toast-mapper.ts`, `toast-root.tsx`, `types.ts`
**Tests:** Add test for `data: { icon: "mydata" }` surviving alongside popser's icon.

### 1.5 Generic manager type (T1)

```typescript
// manager.ts
manager = Toast.createToastManager<PopserToastData>();
```

One-line change. Eliminates the `as PopserToastData` cast in `toast-root.tsx`.

**Files:** `manager.ts`, `toast-root.tsx`

### 1.6 Optimize untrackToast (B5)

Add a reverse map `toastIdToTitle: Map<string, string>` for O(1) cleanup:

```typescript
// toast-tracker.ts
const toastIdToTitle = new Map<string, string>();

export function trackToast(id: string, title: unknown, deduplicate?: boolean) {
  activeToasts.add(id);
  if (deduplicate === true && typeof title === "string") {
    activeToastTitles.set(title, id);
    toastIdToTitle.set(id, title);
  }
}

export function untrackToast(id: string) {
  activeToasts.delete(id);
  const title = toastIdToTitle.get(id);
  if (title !== undefined) {
    activeToastTitles.delete(title);
    toastIdToTitle.delete(id);
  }
}
```

**Files:** `toast-tracker.ts`
**Tests:** Existing dedup tests cover this. Add performance test for 1000 dedup toasts.

---

## Phase 2 — Core Features

### 2.1 `toast.custom(jsx)` (P0)

**What:** Render arbitrary JSX as a toast, bypassing the default icon/title/description/actions structure.

**Sonner API:**
```typescript
toast.custom((id) => <MyToast id={id} onClose={() => toast.dismiss(id)} />)
```

**Popser API (matching Sonner):**
```typescript
toast.custom((id: string) => <MyToast id={id} />, options?)
```

**Implementation:**

1. Add `jsx` field to `PopserToastData`:
   ```typescript
   interface PopserToastData {
     __popser: PopserInternalData;
     jsx?: (id: string) => ReactNode;
     [key: string]: unknown;
   }
   ```

2. Add `toast.custom()` method:
   ```typescript
   // toast.ts
   toast.custom = (
     jsx: (id: string) => ReactNode,
     options?: Omit<PopserOptions, "type" | "icon" | "action" | "cancel">
   ): string => {
     const resolvedId = { current: "" };
     const managerOptions = toManagerOptions(
       undefined, // no title
       { ...options, type: "__custom" },
       () => untrackToast(resolvedId.current),
       resolvedId,
       jsx
     );
     const id = getManager().add(managerOptions);
     resolvedId.current = id;
     trackToast(id, undefined, false);
     return id;
   };
   ```

3. Detect in `PopserToastRoot`:
   ```tsx
   // toast-root.tsx
   if (popserData.jsx) {
     return (
       <Toast.Root
         toast={toastData}
         swipeDirection={effectiveSwipeDirection}
         className={classNames?.root}
         data-popser-root
         data-popser-id={toastData.id}
         data-type="custom"
       >
         {popserData.jsx(toastData.id)}
       </Toast.Root>
     );
   }
   // ... existing render path
   ```

4. Custom toasts skip icons, close button, actions — user controls everything.
5. Base UI still provides transitions, swipe, stacking, ARIA.

**Files:** `types.ts`, `toast-mapper.ts`, `toast.ts`, `toast-root.tsx`
**Tests:** Custom render, close from within, options passthrough, stacking with regular toasts.

### 2.2 Enhanced `toast.promise()` (P0)

**What:** Match Sonner's full promise API.

**New features:**

#### a) Lazy promise

```typescript
toast.promise(() => fetchData(), { ... })
```

Accept `Promise<T> | (() => Promise<T>)`. If function, call it immediately.

#### b) Per-state options (PromiseExtendedResult)

```typescript
toast.promise(fetchData(), {
  loading: "Loading...",
  success: (data) => ({
    title: `Loaded ${data.count} items`,
    description: "All items ready",
    icon: <CheckIcon />,
    timeout: 3000,
    action: { label: "View", onClick: () => navigate("/items") },
  }),
  error: (err) => ({
    title: `Failed: ${err.message}`,
    timeout: 10000,
  }),
})
```

**Type:**
```typescript
interface PopserPromiseExtendedResult extends Partial<PopserOptions> {
  title: ReactNode;
}

type PopserPromiseHandler<T> =
  | ReactNode
  | ((result: T) => ReactNode | PopserPromiseExtendedResult | undefined);
```

When handler returns an object with `title` property → treat as extended result.
When handler returns ReactNode → use as title (existing behavior).
When handler returns `undefined` → close the toast.

#### c) `finally` clause

```typescript
toast.promise(fetchData(), {
  loading: "Saving...",
  success: "Saved!",
  error: "Failed",
  finally: () => cleanup(),
})
```

Add `finally?: () => void | Promise<void>` to `PopserPromiseOptions`. Run after success/error handler.

#### d) Per-state `description`

```typescript
toast.promise(fetchData(), {
  loading: "Loading...",
  success: "Done!",
  error: "Failed",
  description: (data) => `Processed at ${new Date().toLocaleTimeString()}`,
})
```

#### e) Return toast ID (not Promise)

Sonner returns the toast ID with `.unwrap()`. Change return type:

```typescript
interface PopserPromiseReturn<T> extends Promise<T> {
  id: string;
}
```

Actually, keep returning `Promise<T>` for backward compat. Add `id` as a non-enumerable property:

```typescript
const result = getManager().promise(promise, options);
Object.defineProperty(result, "id", { value: toastId, enumerable: false });
return result as Promise<T> & { id: string };
```

**Files:** `types.ts`, `toast.ts`
**Tests:** Lazy promise, extended result, finally, description function, undefined close, ID on return.

### 2.3 Per-toast `classNames` (P1)

**What:** Allow classNames on individual toasts, not just on Toaster.

```typescript
toast.success("Saved", {
  classNames: {
    root: "my-special-toast",
    title: "font-bold",
  },
})
```

**Implementation:**

1. Add `classNames?: Partial<PopserClassNames>` to `PopserOptions`.
2. In `toast-root.tsx`, merge per-toast classNames with Toaster-level classNames:
   ```typescript
   const mergedClassNames = {
     ...toasterClassNames,
     ...perToastClassNames,
     // For each slot, concatenate both if present:
     root: [toasterClassNames?.root, perToastClassNames?.root].filter(Boolean).join(" ") || undefined,
     // ... same for all 11 slots
   };
   ```
3. Store in `__popser.classNames` in data.

**Files:** `types.ts`, `toast-mapper.ts`, `toast-root.tsx`, `toast-action.tsx`, `toast-close.tsx`
**Tests:** Per-toast classNames, merge with Toaster classNames, override behavior.

### 2.4 Per-toast `unstyled` (P1)

```typescript
toast("Custom styled", { unstyled: true, className: "my-class" })
```

Add `unstyled?: boolean` to `PopserOptions`. When set, skip default `data-popser-*` styling attributes (but keep data attributes for testing). Implementation: set `data-unstyled` on `Toast.Root`, CSS targets `[data-popser-root]:not([data-unstyled])` for default styles.

**Files:** `types.ts`, `toast-mapper.ts`, `toast-root.tsx`, `styles/popser.css`
**Tests:** Unstyled toast rendering, data attributes still present.

### 2.5 `pauseOnHover` control (P1)

**Problem:** Base UI's viewport always pauses timers on hover. There's no prop to disable it.

**Approach:** Base UI handles this internally in `ToastViewport`. We can't disable it via props. Instead, implement at popser level:

1. Add `pauseOnHover?: boolean` to `ToasterProps` (default: `true`).
2. When `pauseOnHover: false`, set a very short re-schedule on mouseenter to counteract Base UI's pause. Actually, this won't work reliably.

**Alternative approach:** When `pauseOnHover: false`, don't pass `onMouseEnter`/`onMouseLeave` to the viewport (for expand behavior), and use CSS `pointer-events: none` on an overlay to prevent Base UI's hover detection. This is hacky.

**Best approach:** Accept the limitation. Base UI always pauses on hover. Document this as "by design for accessibility — hovering indicates the user is reading." If users truly need non-pausing toasts, they can set `timeout: 0` and manage dismissal manually.

**Decision:** **Defer.** Document the behavior. If Base UI adds a `pauseOnHover` prop, expose it.

### 2.6 Action/Cancel as ReactNode (P1)

**What:** Allow raw JSX for action/cancel buttons, not just `{ label, onClick }`.

```typescript
toast("Deleted", {
  action: <Button onClick={handleUndo}>Undo</Button>,
  cancel: <Button variant="ghost">Dismiss</Button>,
})
```

**Implementation:**

1. Update types:
   ```typescript
   export interface PopserOptions {
     action?: PopserAction | ReactNode;
     cancel?: PopserAction | ReactNode;
   }
   ```

2. In `toast-action.tsx`, detect if action is ReactNode or object:
   ```typescript
   function isPopserAction(value: unknown): value is PopserAction {
     return typeof value === "object" && value !== null && "label" in value;
   }
   ```

3. When ReactNode: render as `<Toast.Action>` children directly (for action) or `<Toast.Close>` children (for cancel).
4. When object: existing behavior.

**Files:** `types.ts`, `toast-action.tsx`
**Tests:** ReactNode action, ReactNode cancel, mixed, existing object format.

---

## Phase 3 — Enhanced Features

### 3.1 `toast.message()` (P2)

Trivial — add typed variant for explicit "default" type:

```typescript
toast.message = (title: ReactNode, options?: Omit<PopserOptions, "type">): string =>
  createToast(title, { ...options, type: "default" });
```

**Files:** `toast.ts`
**Tests:** One test verifying type is "default".

### 3.2 Per-toast `position` (P2)

**Problem:** Sonner allows per-toast position override. Base UI doesn't natively support this — all toasts in a Viewport share the same position.

**Approach:** This requires multiple Viewports (one per position) or CSS-based positioning per toast. This is architecturally complex with a single manager.

**Decision:** **Defer to v0.3.** Would require multi-viewport architecture or a significant rewrite. Document as intentional: "Position is set on Toaster for consistent UX."

### 3.3 Per-toast `richColors` (P2)

```typescript
toast.success("Saved", { richColors: true })
```

Add `richColors?: boolean` to `PopserOptions`. Set `data-rich-colors` on individual `Toast.Root` when enabled. CSS already targets `[data-rich-colors]` — just need to support it at the toast level too.

**Files:** `types.ts`, `toast-mapper.ts`, `toast-root.tsx`, `styles/popser.css`
**Tests:** Per-toast rich colors, interaction with Toaster-level richColors.

### 3.4 Callback receives toast ID (P2)

**What:** Pass the toast ID to callbacks so users can reference the toast.

```typescript
toast("Action needed", {
  onClose: (id) => console.log(`Toast ${id} closed`),
  onAutoClose: (id) => analytics.track("toast_timeout", { id }),
  onDismiss: (id) => analytics.track("toast_dismissed", { id }),
})
```

**Implementation:** Update callback signatures:

```typescript
onClose?: (id: string) => void;
onAutoClose?: (id: string) => void;
onDismiss?: (id: string) => void;
```

This is backward-compatible — existing `() => void` callbacks will ignore the argument.

**Files:** `types.ts`, `toast-mapper.ts`
**Tests:** Verify ID is passed to all callbacks.

### 3.5 `Toast.Positioner` support — anchored toasts (P2)

**What:** Allow toasts to be anchored to a DOM element.

```typescript
toast("Field is required", {
  anchor: inputRef.current,
  anchorSide: "bottom",
  anchorAlign: "start",
})
```

**Implementation:**

1. Add anchor options to `PopserOptions`:
   ```typescript
   anchor?: Element | null;
   anchorSide?: "top" | "bottom" | "left" | "right";
   anchorAlign?: "start" | "center" | "end";
   anchorOffset?: number;
   ```

2. Map to Base UI's `positionerProps`:
   ```typescript
   // toast-mapper.ts
   if (options.anchor) {
     managerOptions.positionerProps = {
       anchor: options.anchor,
       side: options.anchorSide ?? "bottom",
       align: options.anchorAlign ?? "center",
       sideOffset: options.anchorOffset ?? 8,
     };
   }
   ```

3. In `toast-root.tsx`, conditionally wrap with `Toast.Positioner`:
   ```tsx
   const content = <Toast.Content>...</Toast.Content>;

   if (toastData.positionerProps?.anchor) {
     return (
       <Toast.Root toast={toastData} swipeDirection={[]}>
         <Toast.Positioner toast={toastData}>
           {content}
         </Toast.Positioner>
       </Toast.Root>
     );
   }
   ```

4. Anchored toasts disable swipe automatically (Base UI behavior).

**Files:** `types.ts`, `toast-mapper.ts`, `toast-root.tsx`
**Tests:** Anchored toast rendering, positioner props passthrough, swipe disabled.

### 3.6 `data-limited` exit styling

Add distinct CSS animation for toasts removed because they exceeded the limit:

```css
[data-popser-root][data-limited] {
  opacity: 0;
  transform: scale(0.95);
  transition: opacity 200ms, transform 200ms;
}
```

**Files:** `styles/popser.css`
**Tests:** Visual only — no unit test needed.

### 3.7 Direction-aware swipe exit

Use `data-swipe-direction` for direction-specific exit animations:

```css
[data-popser-root][data-ending-style][data-swipe-direction="left"] {
  transform: translateX(-100%);
}
[data-popser-root][data-ending-style][data-swipe-direction="right"] {
  transform: translateX(100%);
}
/* ... up/down variants */
```

**Files:** `styles/popser.css`
**Tests:** Visual only.

---

## Phase 4 — Polish & Documentation

### 4.1 `toastOptions` prop on Toaster

Global defaults for all toasts:

```tsx
<Toaster
  toastOptions={{
    timeout: 3000,
    className: "my-toast",
    classNames: { title: "font-bold" },
  }}
/>
```

**Implementation:** Merge `toastOptions` defaults into each toast in `toast-mapper.ts`. Per-toast options take precedence.

**Files:** `types.ts`, `toaster.tsx`, `toast-mapper.ts`
**Tests:** Default merging, per-toast override.

### 4.2 `mobileOffset` prop

Separate offset value for mobile:

```tsx
<Toaster offset={24} mobileOffset={16} />
```

**Implementation:** Set `--popser-mobile-offset` CSS variable when `data-mobile` is present. CSS uses this instead of `--popser-offset` on mobile.

**Files:** `types.ts`, `toaster.tsx`, `styles/popser.css`

### 4.3 Update docs

- Update `popser-sonner.md` with all new API additions
- Update `popser-toast.md` with Toast.Positioner usage
- Add migration section for v0.1 → v0.2 (no breaking changes, just new options)
- Document callback firing order with diagram
- Document `onRemove` semantics

### 4.4 shadcn registry update

Update the shadcn component to expose new props:
- `toastOptions` passthrough
- `mobileOffset`
- Updated CSS variable mappings

---

## Deferred to v0.3+

| Feature | Reason |
|---------|--------|
| Multiple Toasters (`toasterId`) | Requires multi-manager architecture — significant rewrite |
| Per-toast `position` | Requires multi-viewport — architectural change |
| `toast.getHistory()` | Intentional: no historical tracking by design |
| `invert` prop | Use `theme` instead — simpler mental model |
| `dir` (RTL) | Base UI handles RTL automatically |
| `hotkey` customization | F6 is ARIA standard, handled by Base UI |
| `pauseOnHover` control | Base UI doesn't expose this — wait for upstream |
| `duration: Infinity` | Already supported via `timeout: 0` |

---

## Implementation Order

```
Phase 1 (patch — v0.1.7 if needed)
├── 1.5  Generic manager type                    [DONE] manager.ts
├── 1.6  Optimize untrackToast                   [DONE] toast-tracker.ts (reverse map)
├── 1.3  Document onRemove                       [DONE] types.ts JSDoc + popser-sonner.md
├── 1.2  Error boundary logging                  [DONE] toaster.tsx componentDidCatch
├── 1.1  Fix promise undefined return            [DONE] toast.ts (queueMicrotask close)
└── 1.4  Fix data field collision                [DONE] toast-mapper.ts (__popser namespace)

Phase 2 (core — v0.2.0-alpha)
├── 2.1  toast.custom(jsx)                       [DONE] toast.ts + toast-root.tsx
├── 2.2  Enhanced toast.promise()                [DONE] toast.ts (lazy, extended, finally, desc)
├── 2.3  Per-toast classNames                    [DONE] toast-root.tsx mergeClassNames()
├── 2.4  Per-toast unstyled                      [DONE] toast-root.tsx data-unstyled
└── 2.6  Action/Cancel as ReactNode              [DONE] toast-action.tsx isPopserAction()

Phase 3 (enhanced — v0.2.0-beta)
├── 3.1  toast.message()                         [DONE] toast.ts
├── 3.2  Per-toast richColors                    [DONE] toast-root.tsx + transitions.css
├── 3.4  Callback receives toast ID              [DONE] types.ts + toast-mapper.ts
├── 3.5  Toast.Positioner (anchored toasts)      [DEFERRED to v0.3]
├── 3.6  data-limited exit styling               [DONE] popser.css (was already in v0.1.6)
└── 3.7  Direction-aware swipe exit              [DONE] popser.css (was already in v0.1.6)

Phase 4 (polish — v0.2.0)
├── 4.1  toastOptions prop                       [DONE] toaster.tsx + toast-root.tsx
├── 4.2  mobileOffset prop                       [DONE] toaster.tsx + viewport.css
├── 4.3  Documentation update                    [DONE] popser-sonner.md
└── 4.4  shadcn registry update                  [DONE] registry/r/popser.json
```

**Actual total:** ~500 lines source changes + ~350 lines new tests + docs + demo page.

---

## Test Plan

Each feature needs:

1. **Unit tests** in co-located `*.test.ts(x)` files
2. **Integration test** in `integration.test.tsx` for DOM rendering
3. **Sonner regression test** in `sonner-regression.test.ts` for compatibility
4. **Performance test** if the feature creates hot paths

Specific test scenarios:

| Feature | Test Scenarios |
|---------|---------------|
| `toast.custom()` | Render JSX, close from within, options passthrough, stacking with regular toasts, swipe, classNames interaction |
| Enhanced promise | Lazy promise, extended result with icon/action/timeout, finally clause, description as function, undefined → close, ID on return, backward compat with string/ReactNode |
| Per-toast classNames | Merge with Toaster classNames, override, all 11 slots, no classNames (null case) |
| Per-toast unstyled | data-unstyled attribute, default styles not applied, data-popser-* still present |
| Action as ReactNode | Raw JSX rendering, type detection, mixed with object format, cancel as ReactNode |
| Anchored toasts | Positioner rendering, props passthrough, swipe disabled, no anchor (fallback) |
| Data collision fix | User data.icon preserved, __popser namespace, backward compat |
| Generic manager | Type inference in toast-root, no runtime change |
| Callback with ID | ID passed to onClose/onAutoClose/onDismiss, existing () => void still works |

**Coverage target:** Maintain 90%+ across all thresholds.

---

## Compatibility Matrix

| Feature | Sonner Compat | Base UI Compat | Breaking? |
|---------|---------------|----------------|-----------|
| `toast.custom()` | API match | Uses `render` prop + data | No |
| Enhanced promise | API match (+ extras) | Native `manager.promise()` | No (additive) |
| Per-toast classNames | API match | CSS classes on elements | No |
| Per-toast unstyled | API match | data attribute | No |
| Action as ReactNode | API match | `<Toast.Action>` children | No (union type) |
| Anchored toasts | Popser-only | `Toast.Positioner` | No |
| `toast.message()` | API match | `type: "default"` | No |
| Callbacks with ID | Superset | Internal routing | No (additive arg) |
| Data collision fix | N/A | Internal | No (internal namespace) |

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| `toast.custom()` JSX rendered inside Base UI Toast.Root may not receive all expected CSS variables | Medium | Test stacking with mixed custom + regular toasts |
| Enhanced promise backward compat — existing `PopserPromiseOptions` callers | High | Union type: `ReactNode | PopserPromiseExtendedResult` — old code still works |
| Per-toast classNames merge complexity — 11 slots × 2 sources | Low | Helper function, tested for each slot |
| Data collision fix — existing code accessing `toastData.data.icon` directly | Medium | Only internal code reads these fields, no public API change |
| Anchored toasts + stacking — anchored toast in a stacked viewport | Medium | Anchored toasts render in separate visual layer via Positioner |
| Bundle size increase | Low | ~460 lines ≈ <1KB gzipped additional |

---

## Success Criteria

- [x] All v0.1 tests pass unchanged (backward compat) -- 279 original tests pass
- [x] Coverage stays above 90% on all thresholds -- 99.16% stmts, 96.62% branches, 96.92% functions, 99.57% lines
- [x] `toast.custom()` works with Sonner migration patterns -- tested with JSX render function
- [x] Enhanced promise accepts all Sonner promise patterns -- lazy, extended, finally, description fn
- [x] No new `!important` in CSS -- verified
- [x] No new peer dependencies -- verified
- [x] Docs fully updated -- popser-sonner.md updated for v0.2.0
- [x] shadcn registry component updated -- registry/r/popser.json with CSS var mapping, next-themes, styles import
- [x] Type-check passes with `verbatimModuleSyntax` and strict mode -- tsc --noEmit clean
- [x] Lint passes (Biome/ultracite) -- 0 errors
- [x] Build passes (ESM + CJS + .d.ts) -- tsup success
- [x] 351 total tests passing (72 new tests for v0.2.0 features)
- [x] Dev demo page updated with v0.2.0 features section
