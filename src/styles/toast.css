/* ─── Toast root ───────────────────────────────────────────────────── */

[data-popser-root] {
  position: absolute;
  z-index: calc(100 - var(--toast-index, 0));
  box-sizing: border-box;
  width: var(--popser-width, 356px);
  padding: 16px;
  font-family: system-ui, -apple-system, sans-serif;
  font-size: 13px;
  line-height: 1.4;
  color: var(--popser-fg);
  pointer-events: auto;
  background: var(--popser-bg);
  border: 1px solid var(--popser-border);
  border-radius: var(--popser-radius, 8px);
  box-shadow: var(--popser-shadow);
}

/* ─── Anchored toasts ─────────────────────────────────────────────── */
/* Anchored toasts are positioned by Toast.Positioner (Floating UI),
 * not by the viewport stacking system. Reset all viewport-driven
 * positioning, stacking opacity/transforms, and transitions. */

[data-popser-root][data-anchored] {
  position: relative;
  inset: auto;
  z-index: auto;
  width: max-content;
  max-width: var(--popser-width, 356px);
  max-height: none;
  overflow: visible;
  transition:
    opacity 200ms cubic-bezier(0.32, 0.72, 0, 1),
    transform 200ms cubic-bezier(0.32, 0.72, 0, 1);
}

/* Custom JSX toasts: strip decorative styles so user content renders cleanly */
[data-popser-root][data-type="custom"] {
  padding: 0;
  background: transparent;
  border: none;
  border-radius: 0;
  box-shadow: none;
}

/* Transitions apply to all non-anchored toasts in both collapsed and expanded
 * modes. This enables smooth animated transitions when expanding/collapsing
 * the stack on hover. Anchored toasts are excluded — positioned by Floating UI. */
[data-popser-viewport] [data-popser-root]:not([data-anchored]) {
  transition:
    transform 400ms cubic-bezier(0.32, 0.72, 0, 1),
    opacity 400ms cubic-bezier(0.32, 0.72, 0, 1),
    max-height 400ms cubic-bezier(0.32, 0.72, 0, 1);
  will-change: transform, opacity;
}

/* Bottom positions: anchor toasts to the bottom of the viewport */
[data-popser-viewport][data-position^="bottom"]
  [data-popser-root]:not([data-anchored]) {
  right: 0;
  bottom: 0;
  transform-origin: center bottom;
}

/* Top positions: anchor toasts to the top of the viewport */
[data-popser-viewport][data-position^="top"]
  [data-popser-root]:not([data-anchored]) {
  top: 0;
  left: 0;
  transform-origin: center top;
}

/* ─── Collapsed stacking (default) ─────────────────────────────────── */
/*
 * Base UI sets these CSS custom properties on each Toast.Root automatically:
 *   --toast-index           : 0 for newest (front), 1, 2, ... for older
 *   --toast-offset-y        : cumulative pixel offset (sum of preceding heights)
 *   --toast-height          : this toast's measured height in pixels
 *   --toast-frontmost-height: set on the Viewport, height of the front toast
 *
 * In collapsed mode, toasts stack on top of each other with a peek effect.
 * The front toast (index 0) is full size. Toasts behind it are scaled down
 * and shifted slightly to create a layered card stack appearance.
 *
 * --popser-stack-peek controls peek distance between stacked toasts (default 14px).
 * --popser-gap controls the expanded spacing between toasts (default 8px).
 */

/* Collapsed: bottom positions (toasts stack upward) */
[data-popser-viewport][data-position^="bottom"]:not([data-expanded])
  [data-popser-root]:not([data-anchored]) {
  height: auto;
  max-height: var(--toast-frontmost-height, none);
  overflow: hidden;
  /*
   * Opacity combines two concerns:
   * 1. Progressive fade: (1 - index * 0.1) → 1.0, 0.9, 0.8 ...
   * 2. Visibility cutoff: clamp(0, visibleCount - index, 1) → 1 when visible, 0 when hidden
   * Result: toasts beyond --popser-visible-count are fully transparent.
   */
  opacity: calc(
    clamp(0, var(--popser-visible-count, 3) - var(--toast-index, 0), 1) *
    (1 - var(--toast-index, 0) * 0.1)
  );
  transform: translateY(
      calc(-1 * var(--toast-index, 0) * var(--popser-stack-peek, 14px))
    )
    scale(calc(1 - var(--toast-index, 0) * 0.05));
}

/* Collapsed: top positions (toasts stack downward) */
[data-popser-viewport][data-position^="top"]:not([data-expanded])
  [data-popser-root]:not([data-anchored]) {
  height: auto;
  max-height: var(--toast-frontmost-height, none);
  overflow: hidden;
  opacity: calc(
    clamp(0, var(--popser-visible-count, 3) - var(--toast-index, 0), 1) *
    (1 - var(--toast-index, 0) * 0.1)
  );
  transform: translateY(
      calc(var(--toast-index, 0) * var(--popser-stack-peek, 14px))
    )
    scale(calc(1 - var(--toast-index, 0) * 0.05));
}

/* Collapsed: hide content of non-front toasts (only card shell visible) */
[data-popser-viewport]:not([data-expanded])
  [data-popser-root]:not(:first-child):not([data-anchored])
  [data-popser-content] {
  opacity: 0;
  transition: opacity 400ms cubic-bezier(0.32, 0.72, 0, 1);
}

/* ─── Expanded state ───────────────────────────────────────────────── */
/*
 * Expansion is controlled entirely by JS via [data-expanded] on the viewport.
 * The Toaster component sets this attribute when:
 * 1. expand={true} prop is set
 * 2. User hovers or focuses the viewport (onMouseEnter/onMouseLeave)
 *
 * Using JS state instead of CSS :has() prevents feedback loops where
 * layout changes cause mouseLeave → collapse → mouseEnter → expand cycles.
 *
 * When expanded, toasts remain absolutely positioned. Their translateY
 * is recalculated from --toast-offset-y (cumulative height of preceding
 * toasts set by Base UI) plus gap. Because the transition rule is always
 * active, the switch between collapsed peek and expanded fan-out animates
 * smoothly.
 */

/* Expanded viewport: allow interaction with all toasts */
[data-popser-viewport][data-expanded] {
  pointer-events: auto;
}

/*
 * Extend the viewport's hover area using a ::before pseudo-element.
 * The viewport has effectively zero height (all children are absolute),
 * so mouseLeave fires when moving beyond the first few toasts.
 *
 * The ::before captures mouse events in the expanded toast column,
 * preventing premature mouseLeave. Critically, this does NOT change
 * the viewport's layout box — avoiding breakage of Floating UI's
 * coordinate system for anchored toasts (Toast.Positioner).
 */
[data-popser-viewport][data-position^="bottom"][data-expanded]::before {
  position: absolute;
  /* Extend upward to cover the full expanded toast column */
  top: -100vh;
  right: 0;
  bottom: 0;
  left: 0;
  pointer-events: auto;
  content: "";
}

[data-popser-viewport][data-position^="top"][data-expanded]::before {
  position: absolute;
  top: 0;
  right: 0;
  /* Extend downward to cover the full expanded toast column */
  bottom: -100vh;
  left: 0;
  pointer-events: auto;
  content: "";
}

/* Expanded: bottom positions — fan upward using cumulative offsets */
[data-popser-viewport][data-position^="bottom"][data-expanded]
  [data-popser-root]:not([data-anchored]) {
  max-height: none;
  overflow: visible;
  opacity: 1;
  transform: translateY(
    calc(
      -1 *
      var(--toast-offset-y, 0px) -
      var(--toast-index, 0) *
      var(--popser-gap, 8px)
    )
  );
}

/* Expanded: top positions — fan downward using cumulative offsets */
[data-popser-viewport][data-position^="top"][data-expanded]
  [data-popser-root]:not([data-anchored]) {
  max-height: none;
  overflow: visible;
  opacity: 1;
  transform: translateY(
    calc(
      var(--toast-offset-y, 0px) +
      var(--toast-index, 0) *
      var(--popser-gap, 8px)
    )
  );
}

/* Expanded: gap-filling pseudo-element prevents mouseLeave between toasts */
[data-popser-viewport][data-expanded]
  [data-popser-root]:not(:last-child):not([data-anchored])::after {
  position: absolute;
  right: 0;
  left: 0;
  height: var(--popser-gap, 8px);
  pointer-events: auto;
  content: "";
}

[data-popser-viewport][data-position^="bottom"][data-expanded]
  [data-popser-root]:not(:last-child):not([data-anchored])::after {
  top: calc(-1 * var(--popser-gap, 8px));
}

[data-popser-viewport][data-position^="top"][data-expanded]
  [data-popser-root]:not(:last-child):not([data-anchored])::after {
  bottom: calc(-1 * var(--popser-gap, 8px));
}

/* Expanded: restore content visibility for all toasts */
[data-popser-viewport][data-expanded]
  [data-popser-root]:not([data-anchored])
  [data-popser-content] {
  opacity: 1;
}
